"use strict";angular.module("mctApp",["ngRoute","ngSanitize","ngResource"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/posts",{templateUrl:"views/posts/index.html",controller:"PostsCtrl"}).when("/posts/new",{templateUrl:"views/posts/new.html",controller:"NewPostCtrl"}).when("/posts/:name",{templateUrl:"views/posts/show.html",controller:"ShowPostCtrl"}).when("/posts/:name/edit",{templateUrl:"views/posts/edit.html",controller:"EditPostCtrl"}).when("/experiments/maze",{templateUrl:"views/experiments/maze.html",controller:"MazeCtrl"}).when("/experiments/cloth",{templateUrl:"views/experiments/cloth.html",controller:"ClothCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("mctApp").controller("MainCtrl",["$scope","$location",function(a,b){a.$location=b,a.$watch("$location.path()",function(b){a.activeNavId=b||"/"}),a.getClass=function(b){return a.activeNavId?a.activeNavId.substring(0,b.length)===b?"active":"":void 0}}]),angular.module("mctApp").controller("PostsCtrl",["$scope","Post","Tag",function(a,b,c){a.query="",a.selectedTags=[],a.init=function(){a.getTags(),a.getPosts()},a.getTagClass=function(b){var c=a.selectedTags.indexOf(b)>=0?"active":"";return c},a.toggleTag=function(b){var c=a.selectedTags.indexOf(b);c>=0?a.selectedTags.splice(c,1):a.selectedTags.push(b),console.log(a.selectedTags)},a.getTags=function(){a.tags=c.query()},a.getPosts=function(){a.posts=b.query()};var d=new Showdown.converter;a.parseContent=function(a){return d.makeHtml(a)}}]),angular.module("mctApp").controller("NewPostCtrl",["$scope","$location","Post",function(a,b,c){a.post={title:"",tags:null,content:""},a.preview="";var d=new Showdown.converter;a.$watch("post.content",function(){a.post.content&&(a.preview=d.makeHtml(a.post.content))}),a.parseContent=function(b){b&&(a.preview=d.makeHtml(b))},a.savePost=function(){var d=new c(a.post);d.$save(),b.path("/posts")}}]),angular.module("mctApp").controller("EditPostCtrl",["$scope","$location","$routeParams","Post",function(a,b,c,d){a.post=d.get({name:c.name});var e=new Showdown.converter;a.$watch("post.content",function(){a.post.content&&(a.preview=e.makeHtml(a.post.content))}),a.savePost=function(){a.post.$save(),b.path("/posts")}}]),angular.module("mctApp").controller("ShowPostCtrl",["$scope","Post","$location","$routeParams",function(a,b,c,d){a.post=b.get({name:d.name});var e=new Showdown.converter;a.$watch("post.content",function(){a.post.content&&(a.content=e.makeHtml(a.post.content))}),a.editPost=function(){c.path("/posts/"+a.post.urlString+"/edit")},a.deletePost=function(){a.post.$delete(),c.path("/posts")}}]),angular.module("mctApp").factory("Post",["$resource",function(a){return a("posts/:name",{name:"@urlString"},{})}]),angular.module("mctApp").factory("Tag",["$resource",function(a){return a("tags/:name",{name:"@urlString"},{})}]),angular.module("mctApp").controller("MazeCtrl",["$scope","Maze","MazeStore",function(a,b,c){a.rows=10,a.columns=10,a.mazes=c.query(),a.init=function(){var c=angular.element(document.getElementById("maze-canvas"))[0];c.width=700,c.height=700,a.maze=new b(c,a.columns,a.rows),a.canvas=c},a.initDemo=function(c){a.maze=a.maze||new b(c,a.columns,a.rows)},a.deleteMaze=function(b){var d=window.confirm("Delete maze: "+b.name);return d?(b.$delete(),a.mazes=c.query(),!1):void 0},a.activeMaze=function(b){return b===a.mazeStore?"active":""},a.saveMaze=function(){var b=a.maze.generateConfig();if(b){if(a.mazeStore)a.mazeStore.config=b,a.mazeStore.$save();else{var d=new c({name:a.name,config:b});d.$save()}a.mazes=c.query()}},a.loadMaze=function(b){a.mazeStore=b,a.name=b.name;var c=JSON.parse(b.config);a.maze.load(c),a.columns=a.maze.columns,a.rows=a.maze.rows},a.solve=function(){a.maze.solve()},a.stop=function(){a.maze.stop()},a.handleMouseDown=function(b){var c=a.maze.cellWidth,d=a.maze.cellHeight,e=Math.floor((b.offsetX-1)/c),f=Math.floor((b.offsetY-1)/d),g=a.maze.findCell(e,f);if(a.maze.startSelection)return a.maze.startSelection=!1,void 0;if(a.maze.endSelection)return a.maze.endSelection=!1,void 0;var h=b.offsetX-g.column*c,i=(g.column+1)*c-b.offsetX,j=b.offsetY-g.row*d,k=(g.row+1)*d-b.offsetY,l={left:h,right:i,top:j,bottom:k},m=a.findLowestDelta(l);g.removeWall(m),a.maze.draw()},a.handleMouseMove=function(b){var c=a.maze.cellWidth,d=a.maze.cellHeight,e=Math.floor(b.offsetX/c),f=Math.floor(b.offsetY/d),g=a.maze.findCell(e,f);a.maze.startSelection&&(a.maze.start=g),a.maze.endSelection&&(a.maze.end=g),a.maze.draw()},a.addStart=function(){a.maze.startSelection=!0},a.addEnd=function(){a.maze.endSelection=!0},a.findLowestDelta=function(a){var b=Object.keys(a).reduce(function(b,c){var d=a[c];return d<a[b]?c:b});return b}}]),angular.module("mctApp").factory("Maze",function(){var a=function(a,b){this.path=a,this.cell=b,this.cell.isBranchPoint=!0,this.branches=[]};a.prototype.getChoices=function(){var a=this.path.history;return this.branches.filter(function(b){return a.indexOf(b)<0})};var b=function(a,b){this.maze=a,this.start=b,this.history=[],this.branchPoints=[],this.cell=b;var c=this.choosePath();this.travelTo(c)};b.prototype.choosePath=function(){var b,c=[];if(this.cell.left&&(b=this.maze.findCell(this.cell.column-1,this.cell.row),this.history.indexOf(b)<0&&c.push(b)),this.cell.right&&(b=this.maze.findCell(this.cell.column+1,this.cell.row),this.history.indexOf(b)<0&&c.push(b)),this.cell.top&&(b=this.maze.findCell(this.cell.column,this.cell.row-1),this.history.indexOf(b)<0&&c.push(b)),this.cell.bottom&&(b=this.maze.findCell(this.cell.column,this.cell.row+1),this.history.indexOf(b)<0&&c.push(b)),c.length>1){var d=new a(this,this.cell);d.branches=c,this.branchPoints.push(d)}var e=c[Math.floor(Math.random()*c.length)];return e},b.prototype.travelTo=function(a){if(this.maze.solveInProgress){if(a===this.maze.end)return window.alert("Win"),this.maze.solveInProgress=!1,void 0;if(!a)for(var b=this.branchPoints[this.branchPoints.length-1],c=1;b;){if(b.getChoices().length>0)return this.maze.draw(),this.travelTo(b.cell),void 0;if(b=this.branchPoints[this.branchPoints.length-c],c>this.branchPoints.length)return window.alert("No solution found"),this.maze.solveInProgress=!1,!1;c++}this.history.push(this.cell),this.cell=a,this.cell.visited=!0;var d=this;this.maze.draw(),window.setTimeout(function(){d.travelTo(d.choosePath())},100)}};var c=function(a,b,c){this.rows=c,this.columns=b,this.defaultFill="lightsteelblue",this.startFill="lightgreen",this.endFill="red",this.branchPointFill="green",this.visitedFill="white",a&&(this.canvas=a,this.ctx=this.canvas.getContext("2d"),this.height=a.height,this.width=a.width),this.reset()};c.prototype.solve=function(){this.solveInProgress||(this.reset(),this.solveInProgress=!0,new b(this,this.start))},c.prototype.stop=function(){this.solveInProgress=!1},c.prototype.getIndex=function(a,b){return a+b*this.columns},c.prototype.findCell=function(a,b){return this.cells[a+b*this.columns]},c.prototype.generateConfig=function(){if(!this.end||!this.start)return console.log("incomplete maze"),void 0;this.changed=!1;var a=this.cells.map(function(a){return{row:a.row,column:a.column,left:a.left,right:a.right,top:a.top,bottom:a.bottom}}),b={rows:this.rows,columns:this.columns,start:{column:this.start.column,row:this.start.row},end:{column:this.end.column,row:this.end.row},cells:a};return this.loadData=b,JSON.stringify(b)},c.prototype.load=function(a){this.solveInProgress=!1,this.loadData=a,console.log(a),this.columns=a.columns,this.rows=a.rows,this.cells=new Array(this.rows*this.columns),this.cellWidth=this.canvas.width/this.columns,this.cellHeight=this.canvas.height/this.rows;var b,c=this;a.cells.forEach(function(a){b=c.addCell(a.column,a.row),b.maze=c,b.top=a.top,b.bottom=a.bottom,b.left=a.left,b.right=a.right,c.cells[c.getIndex(a.column,a.row)]=b}),this.start=this.findCell(a.start.column,a.start.row),this.end=this.findCell(a.end.column,a.end.row),this.draw()},c.prototype.reset=function(){if(this.changed)return window.alert("Reset will destroy new data"),!1;if(this.loadData)return this.load(this.loadData),void 0;var a,b,c;for(this.cellWidth=this.canvas.width/this.columns,this.cellHeight=this.canvas.height/this.rows,this.cells=new Array(this.rows*this.columns),a=0;a<this.rows;a++)for(b=0;b<this.columns;b++)c=this.addCell(b,a);this.draw()},c.prototype.addCell=function(a,b){var c=new d(a,b);return c.maze=this,this.cells[this.getIndex(a,b)]=c,c},c.prototype.draw=function(){if(this.canvas){var a=this.ctx;a.clearRect(0,0,this.width,this.height),this.cells.forEach(function(b){b.draw(a)})}};var d=function(a,b){this.column=a,this.row=b,this.fill="lightsteelblue",this.left=!1,this.right=!1,this.top=!1,this.bottom=!1};return d.prototype.removeWall=function(a){this.maze.changed=!0;var b,c=this.maze;if("left"===a){if(this.column-1<0)return;b=c.findCell(this.column-1,this.row),b&&(this.left=this.left?!1:!0,b.right=b.right?!1:!0)}if("right"===a){if(this.column+1>=c.columns)return;b=c.findCell(this.column+1,this.row),b&&(this.right=this.right?!1:!0,b.left=b.left?!1:!0)}if("top"===a){if(this.row-1<0)return;b=c.findCell(this.column,this.row-1),b&&(this.top=this.top?!1:!0,b.bottom=b.bottom?!1:!0)}if("bottom"===a){if(this.row+1>=c.rows)return;b=c.findCell(this.column,this.row+1),console.log(b),b&&(this.bottom=this.bottom?!1:!0,b.top=b.top?!1:!0)}console.log(this)},d.prototype.draw=function(a){a.lineWidth=1;var b=this.maze.cellWidth,c=this.maze.cellHeight;a.fillStyle=this.maze.start===this?this.maze.startFill:this.maze.end===this?this.maze.endFill:this.isBranchPoint?this.maze.branchPointFill:this.visited?this.maze.visitedFill:this.fill,a.beginPath(),a.fillRect(this.column*b,this.row*c,b,c),a.closePath(),this.left||(a.strokeStyle=this.leftColor,a.beginPath(),a.moveTo(this.column*b,this.row*c),a.lineTo(this.column*b,(this.row+1)*c),a.closePath(),a.stroke()),this.right||(a.strokeStyle=this.rightColor,a.beginPath(),a.moveTo((this.column+1)*b,this.row*c),a.lineTo((this.column+1)*b,(this.row+1)*c),a.closePath(),a.stroke()),this.top||(a.strokeStyle=this.topColor,a.beginPath(),a.moveTo(this.column*b,this.row*c),a.lineTo((this.column+1)*b,this.row*c),a.closePath(),a.stroke()),this.bottom||(a.strokeStyle=this.bottomColor,a.beginPath(),a.moveTo(this.column*b,(this.row+1)*c),a.lineTo((this.column+1)*b,(this.row+1)*c),a.closePath(),a.stroke())},c}),angular.module("mctApp").factory("MazeStore",["$resource",function(a){return a("mazes/:name",{name:"@urlString"})}]),angular.module("mctApp").controller("ClothCtrl",["$scope","Cloth",function(a,b){a.options={rows:15,columns:15},a.initDemo=function(c){a.cloth=new b(c,a.options)},a.reset=function(){a.cloth&&a.cloth.reset(a.options)},a.handleMouseDown=function(b){var c=b.offsetX,d=b.offsetY,e=a.cloth.findClosestPoint(c,d);e.fill="red",e.draw(a.cloth.ctx),console.log(e)},a.handleMouseMove=function(a){console.log(a)},a.handleMouseUp=function(a){console.log(a)}}]),angular.module("mctApp").directive("demo",["$window",function(a){return{templateUrl:"templates/demo.html",restrict:"E",replace:!0,link:function(b,c){function d(){var a=c[0].clientWidth,d=c[0].clientHeight;e=c[0].children[0],e.width=a,e.height=d,b.initDemo(e)}var e;d(),a.onresize=d}}}]),angular.module("mctApp").factory("Cloth",function(){var a,b,c;return a=function(a,b){this.canvas=a,this.reset(b)},a.defaults={rows:15,columns:15,springConstant:10},a.prototype.reset=function(b){b=b||a.defaults,this.rows=b.rows,this.columns=b.columns,this.springConstant=b.springConstant,this.points=[this.rows*this.columns],this.constraints=[],this.width=this.canvas.width,this.offsetWidth=.8*this.width,this.dx=this.offsetWidth/this.columns,this.offsetX=.1*this.width,this.height=this.canvas.height,this.offsetHeight=.6*this.height,this.dy=this.offsetHeight/this.rows,this.offsetY=.1*this.height,this.generatePoints(),this.generateConstraints(),this.ctx=this.canvas.getContext("2d"),this.ctx&&this.draw(this.ctx)},a.prototype.generatePoints=function(){for(var a=0,b=this.columns;b>a;a++)for(var c=0,d=this.rows;d>c;c++)this.addPoint(a,c)},a.prototype.addPoint=function(a,c){this.points[this.getIndex(a,c)]=new b(this,a,c)},a.prototype.generateConstraints=function(){for(var a,b,c=this.springConstant,d=0,e=this.columns;e>d;d++)for(var f=0,g=this.rows;g>f;f++)d>0&&(a=this.points[this.getIndex(d-1,f)],b=this.points[this.getIndex(d,f)],this.addConstraint(a,b,c)),f>0&&(a=this.points[this.getIndex(d,f-1)],b=this.points[this.getIndex(d,f)],this.addConstraint(a,b,c))},a.prototype.addConstraint=function(a,b,d){this.constraints.push(new c(a,b,d))},a.prototype.getIndex=function(a,b){return a+b*this.rows},a.prototype.draw=function(a){this.constraints.forEach(function(b){b.draw(a)}),this.points.forEach(function(b){b.draw(a)})},a.prototype.findClosestPoint=function(a,b){var c,d=1e3,e=null;return this.points.forEach(function(f){c=Math.sqrt(Math.pow(f.x-a,2)+Math.pow(f.y-b,2)),d>c&&(e=f,d=c)}),e},b=function(a,b,c){this.cloth=a,this.column=b,this.row=c,this.fill="black",this.x=this.column*this.cloth.dx+this.cloth.offsetX,this.y=this.row*this.cloth.dy+this.cloth.offsetY},b.prototype.draw=function(a){a.beginPath(),a.fillStyle=this.fill,a.arc(this.x,this.y,3,0,6.28,0),a.closePath(),a.fill()},c=function(a,b,c){this.p1=a,this.p2=b,this.k=c},c.prototype.draw=function(a){a.beginPath(),a.moveTo(this.p1.x,this.p1.y),a.lineTo(this.p2.x,this.p2.y),a.closePath(),a.stroke()},a});